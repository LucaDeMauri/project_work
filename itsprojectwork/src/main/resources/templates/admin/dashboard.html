<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="it">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" th:href="@{/css/admin/dashboard.css}"/>
  <!-- Early apply tema per evitare flicker -->
  <script>
    (function () {
      try {
        const saved = localStorage.getItem('theme'); // "dark" | "light" | null
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const useDark = saved ? saved === 'dark' : prefersDark;
        document.documentElement.classList.toggle('dark-mode', useDark);
      } catch (_) {}
    })();
  </script>

  <!-- ===== CSS COMPLETO (puoi spostarlo in /css/internship/admin.css) ===== -->

</head>
<body>

<header class="admin-topbar">
  

  <nav class="right">
    <a class="btn ghost" th:href="@{/internship/dashboard}" title="Torna alla Dashboard">‚Üê Dashboard</a>
    <a class="btn" th:href="@{/admin/candidature}">Gestisci Candidature</a>
    <!-- <<<<<< BOTTPNE LIGHT/DARK >>>>>> -->
    <button class="dark-mode-toggle" id="darkModeToggle" onclick="toggleDarkMode()">üåì</button>
    <form method="post" th:action="@{/auth/logout}">
      <button class="btn danger">Esci</button>
    </form>
  </nav>
</header>

<main class="admin-page">
  <!-- COLONNA SINISTRA: CREAZIONE ANNUNCIO -->
  <section class="panel">
    <h2 class="panel-title">Crea un nuovo annuncio</h2>

    <!-- Cambia qui la rotta se usi un endpoint diverso -->
    <form class="form" method="post" th:action="@{/admin/annunci/crea}">
      <div class="grid">
        <div class="field">
          <label for="titolo">Titolo <span>*</span></label>
          <input id="titolo" name="titolo" required placeholder="Tirocinio Backend Java"/>
        </div>

        <div class="field">
          <label for="aziendaId">Azienda</label>
          <select id="aziendaId" name="aziendaId">
            <option value="">Seleziona Azienda‚Ä¶</option>
            <option th:each="az : ${listaAziende}" th:value="${az.id}" th:text="${az.nome}">Azienda</option>
          </select>
        </div>

        <div class="field">
          <label for="data_inizio">Data Inizio</label>
          <input id="data_inizio" name="data_inizio" type="date"/>
        </div>

        <div class="field">
          <label for="data_fine">Data Fine</label>
          <input id="data_fine" name="data_fine" type="date"/>
        </div>

        <div class="field">
          <label for="tipoMansione">Tipo di Mansione</label>
          <input id="tipoMansione" name="tipoMansione" placeholder="Developer / Frontend / Analyst"/>
        </div>

        <div class="field">
          <label for="location">Location</label>
          <input id="location" name="location" placeholder="Roma (ibrido)"/>
        </div>

        <div class="field">
          <label for="orari">Orari</label>
          <input id="orari" name="orari" placeholder="Lun‚ÄìVen 9‚Äì17"/>
        </div>

        <div class="field full">
          <label for="descrizione">Descrizione</label>
          <textarea id="descrizione" name="descrizione" rows="3" placeholder="Cosa farai, requisiti, benefit‚Ä¶"></textarea>
        </div>

        <!-- ========= COMPETENZE RICHIESTE ========= -->
        <div class="field full">
          <label for="skillsRequiredInput">Competenze Richieste</label>

          <div class="tagbox" data-name="skillsRequired" id="skillsRequiredBox">
            <div class="tags" aria-live="polite" aria-label="Competenze scelte"></div>

            <div class="tagbox-input">
              <input id="skillsRequiredInput"
                     type="text"
                     list="skillsCatalogList"
                     placeholder="Cerca o aggiungi competenza‚Ä¶"
                     autocomplete="off"/>
              <button type="button" class="add-tag" aria-label="Aggiungi">+</button>
            </div>

            <div class="hidden-values"></div>
          </div>

          <!-- Catalogo suggerimenti -->
          <datalist id="skillsCatalogList">
            <option th:each="c : ${listaCompetenze}" th:value="${c.descrizione}" th:text="${c.descrizione}">Java</option>
          </datalist>

          <small>Invio o ‚Äú+‚Äù per aggiungere. Clicca ‚Äú√ó‚Äù per rimuovere. Niente duplicati.</small>
        </div>

        <!-- ========= COMPETENZE ACQUISITE ========= -->
        <div class="field full">
          <label for="skillsDevelopInput">Competenze Acquisite</label>

          <div class="tagbox" data-name="skillsDevelop" id="skillsDevelopBox">
            <div class="tags" aria-live="polite" aria-label="Competenze scelte"></div>

            <div class="tagbox-input">
              <input id="skillsDevelopInput"
                     type="text"
                     list="skillsCatalogList"
                     placeholder="Cerca o aggiungi competenza‚Ä¶"
                     autocomplete="off"/>
              <button type="button" class="add-tag" aria-label="Aggiungi">+</button>
            </div>

            <div class="hidden-values"></div>
          </div>

          <small>Le competenze che lo studente svilupper√† durante lo stage.</small>
        </div>
      </div>

      <div class="actions">
        <button class="btn primary" type="submit">Crea annuncio</button>
      </div>
    </form>
  </section>

  <!-- COLONNA DESTRA: ANNUNCI ESISTENTI -->
  <section class="panel">
    <div class="panel-header">
      <h2 class="panel-title">Annunci esistenti</h2>
      <div class="mini-tip">Disattiva per nascondere l‚Äôannuncio dalla dashboard studenti.</div>
    </div>

    <div class="cards">
      <article class="card" th:each="a : ${listaAnnunci}">
        <div class="avatar" th:text="${#strings.substring(a.titolo,0,1)}">A</div>

        <div class="content" style="flex:1">
          <h3 class="title" th:text="${a.titolo}">Titolo annuncio</h3>
          <div class="meta">
            <span class="chip" th:text="${a.azienda != null ? a.azienda.nome : '‚Äî'}">Azienda</span>
            <span>‚Ä¢</span>
            <span th:text="${a.data_inizio}">Inizio</span>
            <span>‚Äì</span>
            <span th:text="${a.data_fine}">Fine</span>
            <span>‚Ä¢</span>
            <span th:text="${a.location}">Roma</span>
          </div>

          <div class="card-actions">
            <a class="btn" th:href="@{/admin/candidature}">Gestisci candidature</a>
            <form method="post"
                  th:action="@{'/admin/disattiva/' + ${a.id}}"
                  onsubmit="return confirmDelete(this)">
              <button class="btn danger">Disattiva</button>
            </form>
          </div>
        </div>
      </article>
    </div>
  </section>
</main>

<!-- ===== JS: Tema + TagBox ===== -->
<script>
  // Toggle tema con persistenza
  (function(){
    const root = document.documentElement;
    const btn = document.getElementById('darkModeToggle');

    function setBtnIcon(){
      if (!btn) return;
      const dark = root.classList.contains('dark-mode');
      btn.textContent = dark ? '‚òÄÔ∏è' : 'üåì';
    }
    // sync body con html
    document.body.classList.toggle('dark-mode', root.classList.contains('dark-mode'));
    setBtnIcon();

    window.toggleDarkMode = function(){
      const willBeDark = !root.classList.contains('dark-mode');
      root.classList.toggle('dark-mode', willBeDark);
      document.body.classList.toggle('dark-mode', willBeDark);
      try { localStorage.setItem('theme', willBeDark ? 'dark' : 'light'); } catch(_) {}
      setBtnIcon();
    };
  })();

  // Conferma azioni distruttive
  function confirmDelete(){ return confirm("Sei sicuro di voler disattivare questo annuncio?"); }

  // ======== COMPONENTE TAGBOX (vanilla JS) ========
  (function () {
    function normalize(v){ return v.trim().replace(/\s+/g,' ').replace(/,+$/,''); }
    function key(v){ return normalize(v).toLowerCase(); }

    function TagBox(root) {
      this.root = root;
      this.name = root.dataset.name; // es. "skillsRequired"
      this.tagsWrap = root.querySelector('.tags');
      this.hiddenWrap = root.querySelector('.hidden-values');
      this.input = root.querySelector('input[type="text"]');
      this.addBtn = root.querySelector('.add-tag');
      this.map = new Map(); // key -> original value

      // Precarica tag gi√† presenti se sei in modalit√† "modifica"
      root.querySelectorAll('.tag[data-value]').forEach(span => {
        this._add(span.getAttribute('data-value'), true);
      });

      // Eventi
      this.addBtn.addEventListener('click', () => this.addFromInput());
      this.input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); this.addFromInput(); }
        if (e.key === 'Backspace' && !this.input.value && this.tagsWrap.lastElementChild) {
          this.tagsWrap.lastElementChild.querySelector('button')?.click();
        }
      });

      this.tagsWrap.addEventListener('click', (e)=>{
        const btn = e.target.closest('button');
        if(!btn) return;
        const span = btn.closest('.tag');
        const val = span?.getAttribute('data-value');
        if (val != null) this.remove(val);
      });
    }

    TagBox.prototype._renderHidden = function(){
      this.hiddenWrap.innerHTML = '';
      for (const [,original] of this.map) {
        const h = document.createElement('input');
        h.type = 'hidden';
        h.name = this.name;   // invia come lista: ?skillsRequired=a&skillsRequired=b
        h.value = original;
        this.hiddenWrap.appendChild(h);
      }
    };

    TagBox.prototype._renderTag = function(original){
      const span = document.createElement('span');
      span.className = 'tag';
      span.setAttribute('data-value', original);
      span.textContent = original;
      const x = document.createElement('button');
      x.type = 'button';
      x.setAttribute('aria-label', 'Rimuovi');
      x.textContent = '√ó';
      span.appendChild(x);
      this.tagsWrap.appendChild(span);
    };

    TagBox.prototype._add = function(value, skipInputClear){
      const v = normalize(value);
      if (!v) return;
      const k = key(v);
      if (this.map.has(k)) return;
      this.map.set(k, v);
      this._renderTag(v);
      this._renderHidden();
      if (!skipInputClear) this.input.value = '';
    };

    TagBox.prototype.addFromInput = function(){
      this._add(this.input.value);
    };

    TagBox.prototype.remove = function(original){
      const k = key(original);
      if (!this.map.has(k)) return;
      this.map.delete(k);
      const el = this.tagsWrap.querySelector(`.tag[data-value="${CSS.escape(original)}"]`);
      if (el) el.remove();
      this._renderHidden();
    };

    const req = document.getElementById('skillsRequiredBox');
    const dev = document.getElementById('skillsDevelopBox');
    if (req) new TagBox(req);
    if (dev) new TagBox(dev);
  })();
</script>
</body>
</html>
