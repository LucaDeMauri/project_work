<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registrazione - StageUp</title>
  <link rel="stylesheet" th:href="@{/css/auth/signup.css}" /> 
</head>

<body>

  <input type="hidden" id="alertMessage" th:value="${message ?: ''}">
  <input type="hidden" id="alertType" th:value="${alertType ?: ''}">

  <div class="top-bar">
    <a th:href="@{/auth/login}">
      <button class="back-button">← Torna al LogIn</button>
    </a>
    </div>

  <div class="registrazione">
    <h2 class="titolo">Crea il tuo account StageUp</h2>
    
    <div id="statusAlertContainer">
    </div>
    
    <form th:action="@{/auth/signup}" method="POST" class="form" onsubmit="return validaPassword()">
      
      <input type="text" id="name" name="nome" placeholder="Nome" required th:value="${nome}" onkeyup="updateSubmitButtonState();" onblur="validateFormatUX('name', /^[A-Za-z\s.]+$/, 'Nome'); updateSubmitButtonState();"/>
      <span id="error-name" class="js-format-error-text"></span>
      
      <input type="text" id="surname" name="cognome" placeholder="Cognome" required th:value="${cognome}" onkeyup="updateSubmitButtonState();" onblur="validateFormatUX('surname', /^[A-Za-z\s.'-]+$/, 'Cognome'); updateSubmitButtonState();"/>
      <span id="error-surname" class="js-format-error-text"></span>
      
      <input type="email" id="email" name="email" placeholder="Email" required th:value="${email}" onkeyup="updateSubmitButtonState()"/>
      
      <input type="password" id="password" name="password" placeholder="Password" required onkeyup="updateSubmitButtonState();" />
      
      <input type="password" id="confirm-password" name="confirmPassword" placeholder="Conferma Password" required onkeyup="updateSubmitButtonState();" />
      
      <span id="passwordMatchMessage" class="js-password-alert" style="display: none;"></span>
      
      <button type="submit" id="submitButton" disabled>Registrati</button>
    </form>
  </div>

  <script>
    const msg = document.getElementById('alertMessage').value;
    const type = document.getElementById('alertType').value;
    const container = document.getElementById('statusAlertContainer');
    
    // Riferimenti ai campi per l'accesso globale
    const nameInput = document.getElementById('name');
    const surnameInput = document.getElementById('surname');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirm-password');
    const submitButton = document.getElementById('submitButton');


    /* --- ALERT & UTILITY FUNCTIONS --- */
    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'custom-alert custom-alert-' + type;
        const messageSpan = document.createElement('span');
        messageSpan.textContent = message;
        alertDiv.appendChild(messageSpan);
        container.innerHTML = '';
        container.appendChild(alertDiv);
    }
    
    function isFormFullyPopulated() {
        const requiredFields = [nameInput, surnameInput, emailInput, passwordInput, confirmPasswordInput];
        for (const field of requiredFields) {
            if (field.value.trim() === '') {
                return false;
            }
        }
        return true;
    }
    
    function isPasswordMatchLogic() {
        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        return password.length > 0 && password === confirmPassword;
    }

    /* --- VALIDATION FORMAT (Frontend UX - Reattiva) --- */
    function validateFormatUX(fieldId, regex, fieldName) {
        const inputField = document.getElementById(fieldId);
        const errorSpan = document.getElementById('error-' + fieldId);
        const value = inputField.value.trim();
        let isValid = true;

        if (value.length > 0 && !regex.test(value)) {
            errorSpan.textContent = `⚠️ Il campo ${fieldName} contiene caratteri non ammessi.`;
            errorSpan.style.color = 'red';
            inputField.style.borderColor = 'red';
            isValid = false;
        } else {
            errorSpan.textContent = '';
            inputField.style.borderColor = '#ccc';
        }
        return isValid;
    }

    // Aggiornamento Real-Time Password Match (UX)
    function updatePasswordMatchUX() {
        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        const messageSpan = document.getElementById('passwordMatchMessage');
        
        messageSpan.classList.remove('js-password-alert-error', 'js-password-alert-success');

        if (password.length === 0 || confirmPassword.length === 0) {
            messageSpan.style.display = 'none';
        } else {
            messageSpan.style.display = 'block';

            if (password !== confirmPassword) {
                messageSpan.textContent = "⚠️ Le password non corrispondono!";
                messageSpan.classList.add('js-password-alert-error');
            } else {
                messageSpan.textContent = "✅ Le password corrispondono.";
                messageSpan.classList.remove('js-password-alert-error');
                messageSpan.classList.add('js-password-alert-success');
            }
        }
    }
    
    /* --- FUNZIONE CHIAVE: Controlla e Abilita il Bottone --- */
    function updateSubmitButtonState() {
        // 1. Esegui i controlli di formato e aggiorna l'UI (le funzioni ritornano lo stato attuale)
        const isNameValid = validateFormatUX('name', /^[A-Za-z\s.]+$/, 'Nome');
        const isSurnameValid = validateFormatUX('surname', /^[A-Za-z\s.'-]+$/, 'Cognome');

        // 2. Aggiorna la UI del messaggio password
        updatePasswordMatchUX(); 
        
        // 3. Condizione finale per l'abilitazione: TUTTO DEVE ESSERE VERO
        const canSubmit = isFormFullyPopulated() && isPasswordMatchLogic() && isNameValid && isSurnameValid;
        
        // Imposta lo stato del pulsante
        submitButton.disabled = !canSubmit;
    }

    /* --- Funzione di validazione finale (Blocco Submit) --- */
    function validaPassword() {
        // Forziamo tutti i controlli al submit
        const isNameFormatValid = validateFormatUX('name', /^[A-Za-z\s.]+$/, 'Nome');
        const isSurnameFormatValid = validateFormatUX('surname', /^[A-Za-z\s.'-]+$/, 'Cognome');
        
        // 1. Controllo Campi Vuoti (PRIORITARIO)
        if (!isFormFullyPopulated()) {
             showAlert("⚠️ Non hai compilato tutti i campi obbligatori.", 'error');
             // Forza la colorazione dei bordi vuoti
             document.querySelectorAll('.form input').forEach(field => {
                 if (field.value.trim() === '') field.style.borderColor = 'red';
             });
             return false;
        }
        
        // 2. Controllo Caratteri
        if (!isNameFormatValid || !isSurnameFormatValid) {
             showAlert("⚠️ Correggi gli errori evidenziati nel Nome e/o Cognome.", 'error');
             return false;
        }

        // 3. Controllo Corrispondenza Password
        if (!isPasswordMatchLogic()) {
            showAlert("⚠️ Le password devono coincidere.", 'error');
            passwordInput.style.borderColor = 'red';
            confirmPasswordInput.style.borderColor = 'red';
            return false;
        }
        
        // Se tutto è OK, invia al backend
        return true;
    }
    
    /* --- Esecuzione Principale: Attiva i Listener e Controlla lo Stato --- */
    window.addEventListener('DOMContentLoaded', () => {
      if (msg) {
           showAlert(msg, type);
      }
      
      // La logica Dark Mode è stata rimossa, ma l'inizializzazione del check
      // deve essere fatta per garantire che i campi ripopolati abilitino il bottone.
      updateSubmitButtonState(); 
    });
  </script>

</body>
</html>