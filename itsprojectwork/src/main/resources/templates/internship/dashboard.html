<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard - StageUp</title>
  <link rel="stylesheet" th:href="@{/css/internship/dashboard.css}"/>

  <!-- Applica SUBITO il tema salvato per evitare flicker -->
  <script>
    (function () {
      try {
        const saved = localStorage.getItem('theme'); // "dark" | "light" | null
        const prefersDark = window.matchMedia &&
                            window.matchMedia('(prefers-color-scheme: dark)').matches;
        const useDark = saved ? saved === 'dark' : prefersDark;

        if (useDark) {
          document.documentElement.classList.add('dark-mode');
        } else {
          document.documentElement.classList.remove('dark-mode');
        }
      } catch (e) {
        // Non bloccare il render se localStorage non √® disponibile
      }
    })();
  </script>
</head>
<body>

<!-- ===== SVG SPRITE ===== -->
<svg xmlns="http://www.w3.org/2000/svg" style="display:none;">
  <symbol id="ic-building" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
    <path d="M3 21h18"/><path d="M9 21V7a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v14"/>
    <path d="M9 10h6M9 14h6M9 18h6"/><path d="M5 21V10a2 2 0 0 1 2-2h2"/>
  </symbol>
  <symbol id="ic-calendar" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
    <rect x="3" y="5" width="18" height="16" rx="2"/><path d="M16 3v4M8 3v4M3 11h18"/>
  </symbol>
  <symbol id="ic-briefcase" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
    <path d="M4 7h16a2 2 0 0 1 2 2v7a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V9a2 2 0 0 1 2-2z"/>
    <path d="M9 7V5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/><path d="M12 12v2"/>
  </symbol>
  <symbol id="ic-pin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
    <path d="M12 21s-7-5.4-7-10a7 7 0 1 1 14 0c0 4.6-7 10-7 10z"/><circle cx="12" cy="11" r="2.5"/>
  </symbol>
  <symbol id="ic-clock" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
    <circle cx="12" cy="12" r="9"/><path d="M12 7v5l3 2"/>
  </symbol>
  <symbol id="ic-spark" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
    <path d="M12 2l1.5 4.5L18 8l-4.5 1.5L12 14l-1.5-4.5L6 8l4.5-1.5L12 2z"/>
    <path d="M19 13l.7 2.1L22 16l-2.3.9L19 19l-.7-2.1L16 16l2.3-.9L19 13z"/>
  </symbol>
</svg>
<!-- ===== /SVG SPRITE ===== -->

<header>
  <div class="header-left">
    <img src="/img/logo.png" alt="StageUp Logo" class="logo"/>
    <h1>Stage Up</h1>
  </div>

  <div class="header-right">
    <button class="dark-mode-toggle" id="darkModeToggle" onclick="toggleDarkMode()">üåì</button>

    <!-- Bottone admin solo per ruolo admin -->
    <a th:if="${utente != null and utente.ruolo == 'admin'}"
       th:href="@{/admin/dashboard}"
       class="admin-panel-btn">‚öôÔ∏è Pannello Admin</a>

    <div class="user-menu">
      <div class="user-avatar" id="userAvatar">
        <img th:src="@{${avatarUrl}}" alt="Avatar utente"/>
        <span th:text="${#strings.substring((utente != null ? utente.nome : 'U'),0,1).toUpperCase()}">U</span>
      </div>
      <div class="dropdown-menu" id="dropdownMenu">
        <a th:href="@{/internship/areapersonale}" class="dropdown-item"><span class="dropdown-icon">üë§</span> Area personale</a>
        <div class="dropdown-divider"></div>
        <a th:href="@{/auth/logout}" class="dropdown-item logout"><span class="dropdown-icon">üö™</span> Logout</a>
      </div>
    </div>
  </div>
</header>

<div class="container">

  <!-- ===== Flash ===== -->
  <div class="flash-wrapper" aria-live="polite" aria-atomic="true">
    <div th:if="${messaggioSuccesso}" class="alert alert-success is-visible" role="alert">
      <span th:text="${messaggioSuccesso}"></span>
      <button type="button" class="alert-close" aria-label="Chiudi">√ó</button>
    </div>
    <div th:if="${messaggioErrore}" class="alert alert-error is-visible" role="alert">
      <span th:text="${messaggioErrore}"></span>
      <button type="button" class="alert-close" aria-label="Chiudi">√ó</button>
    </div>
    <div th:if="${message} and ${alertType} == 'success'" class="alert alert-success is-visible" role="alert">
      <span th:text="${message}"></span>
      <button type="button" class="alert-close" aria-label="Chiudi">√ó</button>
    </div>
    <div th:if="${message} and ${alertType} == 'error'" class="alert alert-error is-visible" role="alert">
      <span th:text="${message}"></span>
      <button type="button" class="alert-close" aria-label="Chiudi">√ó</button>
    </div>
  </div>

  <!-- ===== Titolo sezione ===== -->
  <div class="section-header">
    <h2 class="section-title">
      Candidature disponibili
      <span class="badge-count"
            th:if="${listaAnnunci != null}"
            th:text="${#lists.size(listaAnnunci)}">0</span>
    </h2>
    <p class="section-subtitle">Scegli lo stage che fa per te e invia la candidatura.</p>
  </div>

  <div class="empty-state"
       th:if="${listaAnnunci == null or #lists.isEmpty(listaAnnunci)}">
    Nessuna candidatura disponibile al momento.
  </div>

  <!-- ===== Griglia ===== -->
  <div class="annunci-grid" id="annunciGrid">
    <div class="annuncio-card"
         th:each="a : ${listaAnnunci}"
         th:with="gia=${idsGiaCandidato != null and #lists.contains(idsGiaCandidato, a.id)}"
         th:attr="data-annuncio-id=${a.id},data-gia=${gia}">

      <!-- Titolo + badge -->
      <div class="annuncio-titolo" th:text="${a.titolo}">Titolo</div>
      <span class="chip-giacandidato" th:if="${gia}">Gi√† candidato</span>

      <!-- Dati sintetici -->
      <div class="dati-annuncio">
        <div class="dato-item">
          <span class="etichetta"><svg class="icon"><use href="#ic-building"/></svg>Azienda:</span>
          <span class="valore" th:text="${a.azienda != null ? a.azienda.nome : '‚Äî'}">‚Äî</span>
        </div>

        <div class="dato-item">
          <span class="etichetta"><svg class="icon"><use href="#ic-calendar"/></svg>Durata:</span>
          <span class="valore">
            <span th:text="${a.data_inizio}">2025-01-01</span> ‚Äì <span th:text="${a.data_fine}">2025-03-31</span>
          </span>
        </div>

        <div class="dato-item">
          <span class="etichetta"><svg class="icon"><use href="#ic-briefcase"/></svg>Mansione:</span>
          <span class="valore" th:text="${a.tipoMansione}">‚Äî</span>
        </div>

        <div class="dato-item">
          <span class="etichetta"><svg class="icon"><use href="#ic-spark"/></svg>Competenze:</span>
          <div class="competence-tags">
            <span class="tag"
                  th:each="c, iStat : ${a.competenzeRichieste}"
                  th:if="${iStat.index < 4}"
                  th:text="${c.descrizione}">Skill</span>
          </div>
        </div>
      </div>

      <button class="btn-candidati"
              type="button"
              th:if="${utente == null or utente.ruolo != 'admin'}">
        Dettagli
      </button>

      <!-- Template per overlay -->
      <div class="overlay-template" style="display:none">
        <h2 class="overlay-title" th:text="${a.titolo}">Titolo</h2>

        <div class="overlay-body-content">
          <div class="overlay-section">
            <h3><svg class="icon"><use href="#ic-building"/></svg>Informazioni Azienda</h3>
            <p><strong><svg class="icon"><use href="#ic-building"/></svg>Azienda:</strong>
              <span th:text="${a.azienda != null ? a.azienda.nome : '‚Äî'}">‚Äî</span></p>
            <p><strong><svg class="icon"><use href="#ic-pin"/></svg>Sede:</strong>
              <span th:text="${a.location}">‚Äî</span></p>
          </div>

          <div class="overlay-section">
            <h3><svg class="icon"><use href="#ic-briefcase"/></svg>Dettagli Stage</h3>
            <p><strong><svg class="icon"><use href="#ic-briefcase"/></svg>Tipo mansione:</strong>
              <span th:text="${a.tipoMansione}">‚Äî</span></p>
            <p><strong><svg class="icon"><use href="#ic-calendar"/></svg>Inizio:</strong>
              <span th:text="${a.data_inizio}">‚Äî</span></p>
            <p><strong><svg class="icon"><use href="#ic-calendar"/></svg>Fine:</strong>
              <span th:text="${a.data_fine}">‚Äî</span></p>
            <p th:if="${a.orari != null}">
              <strong><svg class="icon"><use href="#ic-clock"/></svg>Orari:</strong>
              <span th:text="${a.orari}"></span>
            </p>
          </div>

          <div class="overlay-section"
               th:if="${a.competenzeRichieste != null and !#lists.isEmpty(a.competenzeRichieste)}">
            <h3><svg class="icon"><use href="#ic-spark"/></svg>Competenze Richieste</h3>
            <div class="competence-tags-large">
              <span class="tag" th:each="c : ${a.competenzeRichieste}" th:text="${c.descrizione}">Skill</span>
            </div>
          </div>

          <div class="overlay-section"
               th:if="${a.competenzeAcquisite != null and !#lists.isEmpty(a.competenzeAcquisite)}">
            <h3><svg class="icon"><use href="#ic-spark"/></svg>Competenze che Acquisirai</h3>
            <div class="competence-tags-large">
              <span class="tag" th:each="c : ${a.competenzeAcquisite}" th:text="${c.descrizione}">Skill</span>
            </div>
          </div>

          <div class="overlay-section" th:if="${a.descrizione != null}">
            <h3>Descrizione</h3>
            <p th:text="${a.descrizione}">‚Äî</p>
          </div>
        </div>
      </div>
    </div>
    <!-- /card -->
  </div>
  <!-- /griglia -->
</div>

<!-- ===== OVERLAY ===== -->
<div class="overlay" id="overlay">
  <div class="overlay-content">
    <button class="btn-close-overlay" id="btnCloseOverlay" type="button">√ó</button>

    <div class="overlay-header">
      <h2 id="overlayTitolo"></h2>
    </div>

    <div class="overlay-body" id="overlayBody"><!-- Popolato da JS --></div>

    <div class="overlay-footer">
      <form th:action="@{/internship/dashboard}" method="post" id="formCandidatura">
        <input type="hidden" name="id" id="annuncioIdInput"/>
        <!-- Il bottone viene inserito/variato via JS in base a data-gia -->
      </form>
    </div>
  </div>
</div>
<!-- ===== /OVERLAY ===== -->

<script>
document.addEventListener('DOMContentLoaded', function () {
  // ----- Dropdown utente -----
  const userAvatar = document.getElementById('userAvatar');
  const dropdownMenu = document.getElementById('dropdownMenu');
  const btn = document.getElementById('darkModeToggle');

  if (userAvatar && dropdownMenu) {
    userAvatar.addEventListener('click', e => {
      e.preventDefault(); e.stopPropagation();
      dropdownMenu.classList.toggle('show');
    });
    document.addEventListener('click', e => {
      if (!userAvatar.contains(e.target) && !dropdownMenu.contains(e.target)) {
        dropdownMenu.classList.remove('show');
      }
    });
  }

  // ----- Overlay -----
  const grid = document.getElementById('annunciGrid');
  const overlay = document.getElementById('overlay');
  const overlayTitolo = document.getElementById('overlayTitolo');
  const overlayBody = document.getElementById('overlayBody');
  const btnCloseOverlay = document.getElementById('btnCloseOverlay');
  const annuncioIdInput = document.getElementById('annuncioIdInput');

  if (grid) {
    grid.addEventListener('click', e => {
      const k = e.target.closest('.btn-candidati');
      if (!k) return;

      const card = k.closest('.annuncio-card');
      const tmpl = card && card.querySelector('.overlay-template');
      if (!card || !tmpl) return;

      const annuncioId = card.getAttribute('data-annuncio-id');
      if (annuncioIdInput) annuncioIdInput.value = annuncioId;

      const titleEl = tmpl.querySelector('.overlay-title');
      const bodyEl  = tmpl.querySelector('.overlay-body-content');
      if (overlayTitolo) overlayTitolo.textContent = titleEl ? titleEl.textContent : 'Dettagli';
      if (overlayBody) overlayBody.innerHTML = bodyEl ? bodyEl.innerHTML : '';

      const gia = card.getAttribute('data-gia') === 'true';
      const form = document.getElementById('formCandidatura');
      if (form) {
        form.querySelectorAll('.btn-conferma-candidatura').forEach(b => b.remove());
        if (gia) {
          const b = document.createElement('button');
          b.type = 'button';
          b.className = 'btn-conferma-candidatura is-disabled';
          b.disabled = true;
          b.setAttribute('aria-disabled', 'true');
          b.title = 'Sei gi√† candidato a questo annuncio';
          b.textContent = 'Gi√† candidato';
          form.appendChild(b);
        } else {
          const b = document.createElement('button');
          b.type = 'submit';
          b.className = 'btn-conferma-candidatura';
          b.textContent = 'Conferma Candidatura';
          form.appendChild(b);
        }
      }

      if (overlay) overlay.classList.add('show');
      document.body.classList.add('overlay-open');
    });
  }

  function closeOverlay() {
    if (overlay) overlay.classList.remove('show');
    document.body.classList.remove('overlay-open');
  }
  if (btnCloseOverlay) btnCloseOverlay.addEventListener('click', closeOverlay);
  if (overlay) overlay.addEventListener('click', e => { if (e.target === overlay) closeOverlay(); });
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape' && overlay && overlay.classList.contains('show')) closeOverlay();
  });

  document.addEventListener('click', e => {
    const disabledBtn = e.target.closest && e.target.closest('.btn-conferma-candidatura.is-disabled');
    if (disabledBtn) { e.preventDefault(); e.stopPropagation(); }
  });

  const alerts = document.querySelectorAll('.alert.is-visible');
  alerts.forEach(alert => {
    const closeBtn = alert.querySelector('.alert-close');
    if (closeBtn) closeBtn.addEventListener('click', () => alert.classList.remove('is-visible'));
    setTimeout(() => alert.classList.remove('is-visible'), 4000);
  });

  // ====== DARK MODE: allineo <body> a <html> e imposto l'icona ======
  const root = document.documentElement;
  if (root.classList.contains('dark-mode')) {
    document.body.classList.add('dark-mode');
  } else {
    document.body.classList.remove('dark-mode');
  }
  if (btn) {
    btn.textContent = (root.classList.contains('dark-mode') || document.body.classList.contains('dark-mode')) ? '‚òÄÔ∏è' : 'üåì';
  }
});

// Toggle globale usato dal tuo onclick="toggleDarkMode()"
function toggleDarkMode() {
  const root = document.documentElement;
  const willBeDark = !(root.classList.contains('dark-mode'));

  // Metti/togli su <html> e su <body> per compatibilit√† CSS
  root.classList.toggle('dark-mode', willBeDark);
  document.body.classList.toggle('dark-mode', willBeDark);

  // Persistenza
  try {
    localStorage.setItem('theme', willBeDark ? 'dark' : 'light');
  } catch (e) {}

  // Icona
  const btn = document.getElementById('darkModeToggle');
  if (btn) btn.textContent = willBeDark ? '‚òÄÔ∏è' : 'üåì';
}
</script>
</body>
</html>
