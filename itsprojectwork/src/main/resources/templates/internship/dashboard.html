<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - StageUp</title>
  <link rel="stylesheet" th:href="@{/css/internship/dashboard.css}" />
</head>
<body>
<header>
  <div class="header-left">
    <img src="/img/logo.png" alt="StageUp Logo" class="logo" />
    <h1>Stage Up</h1>
  </div>

  <div class="header-right">
    <button class="dark-mode-toggle" id="darkModeToggle" onclick="toggleDarkMode()">🌓</button>
    <div class="user-menu">
      <div class="user-avatar" id="userAvatar"><span>U</span></div>
      <div class="dropdown-menu" id="dropdownMenu">
        <a href="/profilo" class="dropdown-item">
          <span class="dropdown-icon">👤</span> Profilo Utente
        </a>
        <div class="dropdown-divider"></div>
        <a th:href="@{/auth/logout}" class="dropdown-item logout">
          <span class="dropdown-icon">🚪</span> Logout
        </a>
      </div>
    </div>
  </div>
</header>

<div class="container">
  <!-- Messaggi Flash -->
  <div th:if="${message}" class="alert success" th:text="${message}"></div>
  <div th:if="${error}" class="alert error" th:text="${error}"></div>

  <div class="annunci-grid" id="annunciGrid">
    <!-- CARD ANNUNCI -->
    <div class="annuncio-card" 
         th:each="a : ${listaAnnunci}" 
         th:attr="data-annuncio-id=${a.id}">
      
      <!-- Titolo -->
      <div class="annuncio-titolo" th:text="${a.titolo}">Titolo</div>

      <!-- Dati sintetici -->
      <div class="dati-annuncio">
        <div class="dato-item">
          <span class="etichetta">Azienda:</span>
          <span class="valore" th:text="${a.azienda != null ? a.azienda.nome : '—'}">—</span>
        </div>

        <div class="dato-item">
          <span class="etichetta">Durata:</span>
          <span class="valore">
            <span th:text="${a.data_inizio}">2025-01-01</span> -
            <span th:text="${a.data_fine}">2025-03-31</span>
          </span>
        </div>

        <div class="dato-item">
          <span class="etichetta">Mansione:</span>
          <span class="valore" th:text="${a.tipoMansione}">—</span>
        </div>

        <div class="dato-item">
          <span class="etichetta">Competenze:</span>
          <div class="competence-tags">
            <span class="tag"
                  th:each="c, iStat : ${a.competenzeRichieste}"
                  th:if="${iStat.index < 4}"
                  th:text="${c.descrizione}">Skill</span>
          </div>
        </div>
      </div>

      <button class="btn-candidati" type="button">Dettagli</button>

      <!-- TEMPLATE DETTAGLI NASCOSTO -->
      <div class="overlay-template" style="display:none">
        <h2 class="overlay-title" th:text="${a.titolo}">Titolo</h2>

        <div class="overlay-body-content">
          <div class="overlay-section">
            <h3>Informazioni Azienda</h3>
            <p><strong>Azienda:</strong> <span th:text="${a.azienda != null ? a.azienda.nome : '—'}">—</span></p>
            <p><strong>Sede:</strong> <span th:text="${a.location}">—</span></p>
          </div>

          <div class="overlay-section">
            <h3>Dettagli Stage</h3>
            <p><strong>Tipo mansione:</strong> <span th:text="${a.tipoMansione}">—</span></p>
            <p><strong>Inizio:</strong> <span th:text="${a.data_inizio}">—</span></p>
            <p><strong>Fine:</strong> <span th:text="${a.data_fine}">—</span></p>
            <p th:if="${a.orari != null}">
              <strong>Orari:</strong> <span th:text="${a.orari}"></span>
            </p>
          </div>

          <div class="overlay-section"
               th:if="${a.competenzeRichieste != null and !#lists.isEmpty(a.competenzeRichieste)}">
            <h3>Competenze Richieste</h3>
            <div class="competence-tags-large">
              <span class="tag" th:each="c : ${a.competenzeRichieste}" th:text="${c.descrizione}">Skill</span>
            </div>
          </div>

          <div class="overlay-section"
               th:if="${a.competenzeAcquisite != null and !#lists.isEmpty(a.competenzeAcquisite)}">
            <h3>Competenze che Acquisirai</h3>
            <div class="competence-tags-large">
              <span class="tag" th:each="c : ${a.competenzeAcquisite}" th:text="${c.descrizione}">Skill</span>
            </div>
          </div>

          <div class="overlay-section" th:if="${a.descrizione != null}">
            <h3>Descrizione</h3>
            <p th:text="${a.descrizione}">—</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- OVERLAY GLOBALE -->
<div class="overlay" id="overlay">
  <div class="overlay-content">
    <button class="btn-close-overlay" id="btnCloseOverlay" type="button">×</button>

    <div class="overlay-header">
      <h2 id="overlayTitolo"></h2>
    </div>

    <div class="overlay-body" id="overlayBody"><!-- Popolato da JS --></div>

    <div class="overlay-footer">
      <!-- FORM PER CONFERMA CANDIDATURA -->
      <form th:action="@{/internship/dashboard}" method="post" id="formCandidatura">
        <input type="hidden" name="id" id="annuncioIdInput" />
        <button class="btn-conferma-candidatura" type="submit">
          Conferma Candidatura
        </button>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const userAvatar = document.getElementById('userAvatar');
  const dropdownMenu = document.getElementById('dropdownMenu');
  const grid = document.getElementById('annunciGrid');

  const overlay = document.getElementById('overlay');
  const overlayTitolo = document.getElementById('overlayTitolo');
  const overlayBody = document.getElementById('overlayBody');
  const btnCloseOverlay = document.getElementById('btnCloseOverlay');
  const annuncioIdInput = document.getElementById('annuncioIdInput');

  // Gestione dropdown utente
  userAvatar.addEventListener('click', e => {
    e.preventDefault(); e.stopPropagation();
    dropdownMenu.classList.toggle('show');
  });
  document.addEventListener('click', e => {
    if (!userAvatar.contains(e.target) && !dropdownMenu.contains(e.target))
      dropdownMenu.classList.remove('show');
  });

  // Click su "Dettagli"
  grid.addEventListener('click', e => {
    const btn = e.target.closest('.btn-candidati');
    if (!btn) return;

    const card = btn.closest('.annuncio-card');
    if (!card) return;

    const tmpl = card.querySelector('.overlay-template');
    if (!tmpl) return;

    // Passa l'id dell'annuncio al form
    const annuncioId = card.getAttribute('data-annuncio-id');
    annuncioIdInput.value = annuncioId;

    // Copia contenuto
    const titleEl = tmpl.querySelector('.overlay-title');
    const bodyEl  = tmpl.querySelector('.overlay-body-content');
    overlayTitolo.textContent = titleEl ? titleEl.textContent : 'Dettagli';
    overlayBody.innerHTML = bodyEl ? bodyEl.innerHTML : '';

    // Mostra overlay
    overlay.classList.add('show');
    document.body.classList.add('overlay-open');
  });

  // Chiudi overlay
  btnCloseOverlay.addEventListener('click', closeOverlay);
  overlay.addEventListener('click', e => { if (e.target === overlay) closeOverlay(); });
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape' && overlay.classList.contains('show')) closeOverlay();
  });

  function closeOverlay() {
    overlay.classList.remove('show');
    document.body.classList.remove('overlay-open');
  }
});

// Dark mode
function toggleDarkMode() {
  const body = document.body;
  const btn = document.getElementById('darkModeToggle');
  body.classList.toggle('dark-mode');
  btn.innerHTML = body.classList.contains('dark-mode') ? '☀️' : '🌓';
}
</script>
</body>
</html>
